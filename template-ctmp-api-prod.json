{  
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"AWS CloudFormation Template for sdtmdss Application",
   "Parameters":{  
      "VpcId":{  
         "Type":"AWS::EC2::VPC::Id",
         "Description":"VPC Id of your existing Virtual Private Cloud (VPC)",
         "ConstraintDescription":"Must be the VPC Id of an existing Virtual Private Cloud"
      },
      "AppServerSubnet":{  
         "Type":"List<AWS::EC2::Subnet::Id>",
         "Description":"Select at least two subnets from different AZs of your Virtual Private Cloud (VPC)",
         "ConstraintDescription":"Must be a list of at least two existing subnets associated with at least two different availability zones. They should be residing in the selected Virtual Private Cloud"
      },
      "AppServerKeyName":{  
         "Description":"Provides the name of the EC2 key pair",
         "Type":"AWS::EC2::KeyPair::KeyName",
         "ConstraintDescription":"Must be the name of an existing EC2 KeyPair"
      },
      "AppServerImageId":{  
         "Description":"Provide the AMI Id for the EC2 instances",
         "Type":"String"
      },
      "AppServerHostName":{  
         "Description":"Provide the <name> tag for the Instance",
         "Type":"String"
      },
      "AppServerInstanceType":{  
         "Description":"Web server EC2 instance type",
         "Type":"String",
         "Default":"t2.medium",
         "AllowedValues":[  
            "t1.micro",
            "t2.nano",
            "t2.micro",
            "t2.small",
            "t2.medium",
            "t2.large",
            "m1.small",
            "m1.medium",
            "m1.large",
            "m1.xlarge",
            "m2.xlarge",
            "m2.2xlarge",
            "m2.4xlarge",
            "m3.medium",
            "m3.large",
            "m3.xlarge",
            "m3.2xlarge",
            "m4.large",
            "m4.xlarge",
            "m4.2xlarge",
            "m4.4xlarge",
            "m4.10xlarge",
            "c1.medium",
            "c1.xlarge",
            "c3.large",
            "c3.xlarge",
            "c3.2xlarge",
            "c3.4xlarge",
            "c3.8xlarge",
            "c4.large",
            "c4.xlarge",
            "c4.2xlarge",
            "c4.4xlarge",
            "c4.8xlarge",
            "g2.2xlarge",
            "g2.8xlarge",
            "r3.large",
            "r3.xlarge",
            "r3.2xlarge",
            "r3.4xlarge",
            "r3.8xlarge",
            "i2.xlarge",
            "i2.2xlarge",
            "i2.4xlarge",
            "i2.8xlarge",
            "d2.xlarge",
            "d2.2xlarge",
            "d2.4xlarge",
            "d2.8xlarge",
            "hi1.4xlarge",
            "hs1.8xlarge",
            "cr1.8xlarge",
            "cc2.8xlarge",
            "cg1.4xlarge"
         ],
         "ConstraintDescription":"Must be a valid EC2 instance type"
      },
      "ELBSubnet1":{  
         "Description":"Provide Subnet Name",
         "Type":"String"
      },
      "ELBSubnet2":{  
         "Description":"Provide Subnet Name",
         "Type":"String"
      },
      "AppServerSecurityGroupName":{  
         "Description":"Provide Web Server SG Name",
         "Type":"String"
      },
      "ELBSecurityGroupName":{  
         "Description":"Provide Internal ELB SG Name",
         "Type":"String"
      },
      "ELBName":{  
         "Description":"Provide Internal ELB Name",
         "Type":"String"
      },
      "Application":{  
         "Description":"Provide Application Name",
         "Type":"String"
      },
      "Consumer":{  
         "Description":"Provide Consumer Name",
         "Type":"String"
      },
      "Costcenter":{  
         "Description":"Provide Costcenter Name",
         "Type":"String"
      },
      "Division":{  
         "Description":"Provide Internal ELB Name",
         "Type":"String"
      },
      "Environment":{  
         "Description":"Provide Division Name",
         "Type":"String"
      },
      "PatchGroup":{  
         "Description":"Provide Patch Group Name",
         "Type":"String"
      },
      "CertificateARN":{  
         "Description":"Provide the Certificate ARN",
         "Type":"String"
      }
   },
   "Resources":{  
      "AppServerSecurityGroup":{  
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{  
            "VpcId":{  
               "Ref":"VpcId"
            },
            "GroupDescription":{  
               "Ref":"AppServerSecurityGroupName"
            },
            "Tags":[  
               {  
                  "Key":"Name",
                  "Value":{  
                     "Ref":"AppServerSecurityGroupName"
                  }
               }
            ],
            "SecurityGroupIngress":[  
               {  
                  "IpProtocol":"tcp",
                  "FromPort":"443",
                  "ToPort":"443",
                  "CidrIp":"0.0.0.0/0"
               },
               {  
                  "IpProtocol":"tcp",
                  "FromPort":"8443",
                  "ToPort":"8443",
                  "CidrIp":"0.0.0.0/0"
               },
               {  
                  "IpProtocol":"tcp",
                  "FromPort":"8080",
                  "ToPort":"8080",
                  "CidrIp":"0.0.0.0/0"
               },
               {  
                  "IpProtocol":"tcp",
                  "FromPort":"80",
                  "ToPort":"80",
                  "CidrIp":"0.0.0.0/0"
               },
               {  
                  "IpProtocol":"tcp",
                  "FromPort":"2022",
                  "ToPort":"2022",
                  "CidrIp":"0.0.0.0/0"
               },
               {  
                  "IpProtocol":"tcp",
                  "FromPort":"8080",
                  "ToPort":"8080",
                  "SourceSecurityGroupId":{  
                     "Ref":"ELBSecurityGroup"
                  }
               }
            ]
         }
      },
      "ELBSecurityGroup":{  
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{  
            "VpcId":{  
               "Ref":"VpcId"
            },
            "GroupDescription":{  
               "Ref":"AppServerSecurityGroupName"
            },
            "Tags":[  
               {  
                  "Key":"Name",
                  "Value":{  
                     "Ref":"AppServerSecurityGroupName"
                  }
               }
            ],
            "SecurityGroupIngress":[  
               {  
                  "IpProtocol":"tcp",
                  "FromPort":"443",
                  "ToPort":"443",
                  "CidrIp":"0.0.0.0/0"
               }
            ]
         }
      },
      "AppServerASGroup":{  
         "Type":"AWS::AutoScaling::AutoScalingGroup",
         "Properties":{  
            "VPCZoneIdentifier":{  
               "Ref":"AppServerSubnet"
            },
            "LaunchConfigurationName":{  
               "Ref":"LaunchConfig"
            },
            "MinSize":"1",
            "MaxSize":"4",
            "LoadBalancerNames":[  
               {  
                  "Ref":"ELB"
               }
            ],
            "Tags":[  
               {  
                  "Key":"Name",
                  "Value":{  
                     "Ref":"AppServerHostName"
                  },
                  "PropagateAtLaunch":"true"
               },
               {  
                  "Key":"Application",
                  "Value":{  
                     "Ref":"Application"
                  },
                  "PropagateAtLaunch":"true"
               },
               {  
                  "Key":"Consumer",
                  "Value":{  
                     "Ref":"Consumer"
                  },
                  "PropagateAtLaunch":"true"
               },
               {  
                  "Key":"Costcenter",
                  "Value":{  
                     "Ref":"Costcenter"
                  },
                  "PropagateAtLaunch":"true"
               },
               {  
                  "Key":"Division",
                  "Value":{  
                     "Ref":"Division"
                  },
                  "PropagateAtLaunch":"true"
               },
               {  
                  "Key":"Environment",
                  "Value":{  
                     "Ref":"Environment"
                  },
                  "PropagateAtLaunch":"true"
               },
               {  
                  "Key":"Patch Group",
                  "Value":{  
                     "Ref":"PatchGroup"
                  },
                  "PropagateAtLaunch":"true"
               }
            ]
         }
      },
      "LaunchConfig":{  
         "Type":"AWS::AutoScaling::LaunchConfiguration",
         "Properties":{  
            "KeyName":{  
               "Ref":"AppServerKeyName"
            },
            "ImageId":{  
               "Ref":"AppServerImageId"
            },
            "InstanceType":{  
               "Ref":"AppServerInstanceType"
            },
            "SecurityGroups":[  
               {  
                  "Ref":"AppServerSecurityGroup"
               }
            ]
         }
      },
      "ELB":{  
         "Type":"AWS::ElasticLoadBalancing::LoadBalancer",
         "Properties":{  
            "LoadBalancerName":{  
               "Ref":"ELBName"
            },
            "Scheme":"Internal",
            "Subnets":[  
               {  
                  "Ref":"ELBSubnet1"
               },
               {  
                  "Ref":"ELBSubnet2"
               }
            ],
            "SecurityGroups":[  
               {  
                  "Ref":"ELBSecurityGroup"
               }
            ],
            "Listeners":[  
               {  
                  "InstancePort":"8080",
                  "InstanceProtocol":"HTTP",
                  "SSLCertificateId":{  
                     "Ref":"CertificateARN"
                  },
                  "LoadBalancerPort":"443",
                  "Protocol":"HTTPS"
               }
            ],
            "HealthCheck":{  
               "Target":"TCP:8080",
               "HealthyThreshold":"10",
               "UnhealthyThreshold":"2",
               "Interval":"30",
               "Timeout":"5"
            }
         }
      }
   }
}